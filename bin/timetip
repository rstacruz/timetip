#!/usr/bin/env node
// vim:ft=javascript

var cli        = require('commander');
var extend     = require('util')._extend;
var _          = require('underscore');
var f          = require('../lib/formatter');
var T          = require('../lib/reporters/default').theme;
var S          = require('../lib/reporters/default').symbols;
var openEditor = require('../lib/helpers').openEditor;
var printUsage = require('../lib/helpers').printUsage;
var duration   = require('../lib/helpers').duration;
var isToday    = require('../lib/helpers').isToday;

cli
  .version(require('../package').version)
  .option('-f, --file <path>', 'the data file [~/.timelogs]', '~/.timelogs')
  .option('-R, --reporter <r>', 'use reporter (default|json)', 'default')
  .option('--no-color', 'disable colors', true)
  .on('--help', function() {
    if (!cli.color) process.env.NO_COLOR = true;

    function us(str) { printUsage(cli._name, str, "1;34"); }
    function ex(str) { printUsage(cli._name, str, 36); }
    function p(str)  { console.log(str); }

    p('  Shortcuts:');
    us('t <task>             # start working (alias: `start`)');
    us('t - [<reason>]       # stop working (alias: `stop`)');
    us('t <date>             # show entries for the date (alias: `show`)');
    us('t                    # show today (alias: `show today`)');
    p('');
    p('  Logging tasks:');
    us('t start <task>       # start working');
    us('t stop [<reason>]    # stop working');
    p('');
    p('  Other commands:');
    us('t show <date>          # show entries for the date');
    us('t show <date> - <end>  # show entries for date range');
    us('t edit                 # open in text editor');
    p('');
    p('  Examples:');
    ex('t Myproject stuff    # start working on "myproject stuff"');
    ex('t Meeting 3m ago     # start working on "meeting" 3 minutes ago');
    ex('t stop               # stop the current task');
    ex('t stop lunch break   # stop the current task and log the reason');
    p('');
    ex('t Sept 2             # show entries september 2');
    ex('t 4 days ago         # show entries from 4 days ago');
    ex('t Yesterday          # show entries from yesterday');
  });

var TimeLog = require('../lib/time_log');

/*
 * The controller
 */

var log = new TimeLog(cli.file);
var reporter;


extend(cli, {
  status: function() {
    var date = new Date();
    var data = this.getLogs(date);
    if (!data.now) return this.noLogs(date);

    this.getReporter().day(data);
  },

  query: function(date) {
    var data = this.getLogs(date);
    this.getReporter().day(data);
  },

  // Start or stop
  log: function(spec) {
    if (!spec) return this.invalidUsage();

    log.push(spec).save();
    this.getReporter().day(log.get(spec.date), { added: true });
  },

  /* ---- */

  noLogs: function(date) {
    console.error('');

    if (isToday(date)) {
      console.error(f(' %s  %s %s',
        T.now(S.check),
        'nothing logged yet today.'));
      console.error(f('    start now! try: %s %s',
        T.accent(cli._name),
        T.accent("<what you're doing>")));
      console.error('');
      console.error("    see `"+cli._name+" --help` for more info.");
    }
    else
      console.error(f(' %s  %s %s %s',
        T.err(S.cross),
        'nothing logged for',
        T.accent(isToday(date) ? 'today' : date.format('{month} {dd}, {yyyy}'))));

    process.exit(0);
  },

  /**
   * Returns logs for a given `date` or dies with a message
   * @private
   */

  getLogs: function(date) {
    var data = log.get(date);
    if (!data) return this.noLogs(date);
    return data;
  },

  /**
   * Returns the reporter asked for in `--reporter`
   * @private
   */

  getReporter: function() {
    if (reporter) return reporter;

    var Reporters = require('..').reporters;
    var Reporter = Reporters[cli.reporter];

    if (!Reporter) {
      console.error(cli._name+": unknown reporter '"+cli.reporter+"'");
      process.exit(26);
    }

    reporter = new Reporter(log);
    return reporter;
  },

  run: function(argv) {
    cli.parse(argv);

    var DateParser = require('../lib/date_parser');
    var SpecParser = require('../lib/spec_parser');
    var cmd  = cli.args[0] || '';
    var rest = cli.args.slice(1).join(' ');
    var args = cli.args.join(' ');

    var date, spec;

    if (!cli.color)
      process.env.NO_COLOR = true;

    if (cmd === 'edit')
      openEditor(cli.file);
    else if (cmd === '')
      this.status();
    else if (cmd === 'stop' || cmd === '-')
      this.log(SpecParser(rest, { mode: 'break' }));
    else if (cmd === 'start')
      this.log(SpecParser(rest));
    else if (cmd === 'show')
      this.query(DateParser(rest) || new Date());
    else if (date = DateParser(args))
      this.query(date);
    else if (spec = SpecParser(args))
      this.log(spec);
  }
});

cli.run(process.argv);
