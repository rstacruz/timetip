#!/usr/bin/env node
// vim:ft=javascript

var cli = require('commander');
var extend = require('util')._extend;

cli
  .version(require('../package').version)
  .option('-f, --file <path>', 'the data file [~/.timelogs]', '~/.timelogs')
  .on('--help', function() {
    console.log('  Usage:');
    console.log('');
    console.log('    '+cli._name+' [start] <project> [<task>]  # start working');
    console.log('    '+cli._name+' stop [<reason>]             # stop working');
    console.log('');
    console.log('    '+cli._name+' status                      # show current status');
    console.log('    '+cli._name+' summary                     # summarize log for all dates');
    console.log('');
    console.log('    '+cli._name+' <date>                      # show entries');
    console.log('    '+cli._name+' <date> - <date>             # show entries for date range');
    console.log('');
    console.log('');
    console.log('  Examples:');
    console.log('');
    console.log('    '+cli._name+' myproject                   # start working on "myproject"');
    console.log('    '+cli._name+' stop                        # stop tracking');
    console.log('    '+cli._name+' stop lunch break            # stop tracking and log the reason');
    console.log('    '+cli._name+' 2 days ago                  # show entries from 2 days ago');
  })
  .parse(process.argv);


if (cli.args.length === 0) {
  cli.outputHelp();
  process.exit(26);
}

var DateParser = require('../lib/date_parser');
var SpecParser = require('../lib/spec_parser');
var TimeLog = require('../lib/time_log');

var cmd  = cli.args[0];
var rest = cli.args.slice(1).join(' ');
var args = cli.args.join(' ');

var date, spec;

/*
 * The controller
 */

App = {
  log: new TimeLog(cli.file),

  status: function() {
    var now = this.log.now();
    if (now.project && now.task)
      console.log('  now  >', now.project+': '+now.task);
    else if (now.type === 'break')
      console.log('  now  >', 'stopped');
    else
      console.log('  now  >', now.project);

    if (new Date() - now.date > 1000)
      console.log('        ', 'running for', now.date.relative().replace(' ago',''));
  },

  query: function(date) {
    console.log("Entries for ", date);
  }
};

if (cmd.match(/^(stop|x)$/)) {
  var reason = cli.args.slice(1);
  App.log.push({ type: 'break', reason: reason, date: new Date() }).save();
  App.status();
}

else if (cmd.match(/^(st|status)$/)) {
  App.status();
}

else if (cmd.match(/^(summary)$/)) {
  App.log.dates().forEach(function(date) {
    App.query(date);
  });
}

else if (cmd.match(/^(start)$/) && (spec = SpecParser(rest))) {
  App.log.push(extend(spec, { date: new Date() })).save();
  App.status();
}

else if (date = DateParser(args)) {
  App.query(date);
}

else if (spec = SpecParser(args)) {
  App.log.push(extend(spec, { date: new Date() })).save();
  App.status();
}

else {
  console.error(""+cli._name+": invalid usage");
  console.error("try `"+cli._name+" --help` for more info");
  process.exit(26);
}
