#!/usr/bin/env node
// vim:ft=javascript

var cli = require('commander');
var extend = require('util')._extend;
var f = require('printf');
var c = require('../lib/helpers').color;

cli
  .version(require('../package').version)
  .option('-f, --file <path>', 'the data file [~/.timelogs]', '~/.timelogs')
  .option('--edit', 'open the data file in a text editor')
  .on('--help', function() {
    function print(str, col) {
      var m = str.match(/^[a-z]+ (?:((?:--)?[a-z]+) )?(?:(.*?))? *# (.*)$/);
      var cmd = m[1], args = m[2].toLowerCase(), text = m[3];
      text = text.replace(/`(.*?)`/, function(_, a) { return c(a, col); });
      cmd = (!cmd) ? cli._name : (cli._name+' '+cmd);
      var left = c(cmd,col) + ' ' + c(args||'', 30);
      console.log(f('    %-45s %s', left, text));
    }

    function usage(str) { print(str, 36); }
    function ex(str) { print(str, 32); }

    console.log('  Logging tasks:');
    usage('t start <task>       # start working');
    usage('t start <task> +<N>  # start working, offset N minutes');
    usage('t stop [<reason>]    # stop working');
    console.log('');
    console.log('  Viewing logs:');
    usage('t                      # show today');
    usage('t show <date>          # show entries for the date');
    usage('t show <date> - <end>  # show entries for date range');
    console.log('');
    console.log('  Shortcuts:');
    usage('t <task>             # start working (alias: `start`)');
    usage('t <date>             # show entries for the date (alias: `show`)');
    console.log('');
    console.log('  Examples:');
    ex('t Myproject stuff    # start working on "Myproject stuff"');
    ex('t stop               # stop the current task');
    ex('t stop lunch break   # stop the current task, and log the reason');
    console.log('');
    ex('t Sept 2             # show entries september 2');
    ex('t 4 days ago         # show entries from 4 days ago');
    ex('t Yesterday          # show entries from yesterday');
  })
  .parse(process.argv);

var DateParser = require('../lib/date_parser');
var SpecParser = require('../lib/spec_parser');
var TimeLog    = require('../lib/time_log');
var duration   = require('../lib/helpers').duration;
var c          = require('../lib/helpers').color;
var f          = require('printf');
var _          = require('underscore');

var cmd  = cli.args[0] || '';
var rest = cli.args.slice(1).join(' ');
var args = cli.args.join(' ');

var date, spec;

/*
 * The controller
 */

var dot = '⋅';
var dash = '┄ ';
var gt = '›';
var peg = '✈';
var chk = '✓';

function puts(str, options) {
  var pre = '          ';
  if (options && options.prefix) pre = '   '+options.prefix+' '+gt;
  console.log(pre, str);
}

App = {
  log: new TimeLog(cli.file),

  status: function() {
    this.statusToday();
  },

  noLogs: function() {
    console.log(cli._name+": no logs yet.");
    console.log("start one with: `"+cli._name+" <your task>`");
    console.log("see `"+cli._name+" --help` for more info.");
  },

  statusToday: function() {
    var self = this;
    var day = _.last(this.log.dates());

    if (!day) {
      this.noLogs();
      process.exit(0);
    }

    var entries = this.log.day(day);
    var now = this.log.now(day);

    console.log("");
    console.log("  " + c(day.format('{month} {dd} {yyyy}'), 34));
    console.log("");

    if (now) {
      entries.forEach(function(entry) { self.entry(entry); });
      self.entry(now, { now: true });
    } else {
      console.log("  no entries");
    }

    console.log('');
  },

  query: function(date) {
    console.log("Entries for ", date);
  },

  entry: function(entry, options) {
    var time = entry.date.format(App.log.formats.time);
    var str, dur;

    var col
    if (entry.type === 'break')
      col = 30;
    else
      col = 37;

    if (entry.type === 'task')
      str = f("%s %s", c(entry.project, col), entry.task||'');
    else if (entry.reason)
      str = c(dot+dot + ' ' + entry.reason, col);
    else
      str = c(dot+dot, col);

    if (options && options.now) {
      time = c(time + '  ', 30) + c(chk, 32);
      dur = duration(new Date() - entry.date);
      if (dur.length)
        dur = c(duration(new Date() - entry.date), 37) + c("+", 32);
      console.log(f('%29s  %-65s  %22s', time, str, dur));
    } else {
      time = c(time + '  ', 30) + c(' ', 32);
      dur = c(duration(entry.duration), 37);
      console.log(f('%29s  %-65s  %12s', time, str, dur));
    }
  }
};

if (cli.edit) {
  var spawn = require('child_process').spawn;
  var editor = process.env['EDITOR'];
  var cmd = editor + " " + cli.file;

  // Vim hack to open the file and scroll to the last line
  // (`vim + ~/.timelogs`)
  if (editor.match(/vim$/)) cmd = editor + " + " + cli.file;

  // Spawn, lol
  var proc = spawn('sh', ['-c', cmd], { stdio: 'inherit' });
}

else if (cmd === '') {
  App.status();
}

else if (cmd === 'stop' || cmd === '-') {
  var reason = cli.args.slice(1).join(' ');
  App.log.push({ type: 'break', reason: reason, date: new Date() }).save();
  App.status();
}

else if (cmd === 'start') {
  spec = SpecParser(rest);
  App.log.push(extend(spec, { date: new Date() })).save();
  App.status();
}

else if (cmd === 'show') {
  App.query(DateParser(rest));
}

else if (date = DateParser(args)) {
  App.query(date);
}

else if (spec = SpecParser(args)) {
  App.log.push(extend(spec, { date: new Date() })).save();
  App.status();
}

else {
  console.error(""+cli._name+": invalid usage");
  console.error("try `"+cli._name+" --help` for more info");
  process.exit(26);
}
